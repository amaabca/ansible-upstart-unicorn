#!upstart
description "Upstart Script for a Rails process"

start on startup
stop on shutdown

respawn

setuid {{ ansible_upstart_unicorn_user }}
setgid {{ ansible_upstart_unicorn_user }}

chdir {{ ansible_upstart_unicorn_app_path }}/current/

script
  bundle exec unicorn -c ./config/unicorn.rb -E {{ ansible_upstart_unicorn_rack_env }} -D
  flock -x 0 < {{ ansible_upstart_unicorn_app_path }}/shared/tmp/pids/unicorn.pid.lock
end script

pre-stop script
exec /bin/bash <<EOT
  exec kill -QUIT `cat {{ ansible_upstart_unicorn_app_path }}/shared/tmp/pids/unicorn.pid`
EOT
end script
